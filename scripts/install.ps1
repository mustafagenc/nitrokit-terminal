# Nitrokit Windows Installer
# PowerShell script to install Nitrokit on Windows

param(
    [string]$InstallPath = "$env:LOCALAPPDATA\Nitrokit",
    [switch]$AddToPath = $true,
    [switch]$CreateDesktopShortcut = $false,
    [switch]$Force = $false
)

$ErrorActionPreference = "Stop"

Write-Host @"
    ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
    ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
    ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
    ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù   

    üöÄ Nitrokit Windows Installer
    A terminal tool for project management and automation

"@ -ForegroundColor Cyan

Write-Host "Starting Nitrokit installation..." -ForegroundColor Green
Write-Host "Installation directory: $InstallPath" -ForegroundColor Yellow

# Check if running as administrator for system-wide installation
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")

if (-not $isAdmin -and $InstallPath.StartsWith($env:ProgramFiles)) {
    Write-Host "‚ö†Ô∏è  Administrator privileges required for system-wide installation." -ForegroundColor Yellow
    Write-Host "Installing to user directory instead: $env:LOCALAPPDATA\Nitrokit" -ForegroundColor Yellow
    $InstallPath = "$env:LOCALAPPDATA\Nitrokit"
}

# Create installation directory
if (Test-Path $InstallPath) {
    if (-not $Force) {
        $response = Read-Host "Installation directory already exists. Overwrite? (y/N)"
        if ($response -ne 'y' -and $response -ne 'Y') {
            Write-Host "Installation cancelled." -ForegroundColor Red
            exit 1
        }
    }
    Remove-Item -Path $InstallPath -Recurse -Force
}

Write-Host "üìÅ Creating installation directory..." -ForegroundColor Blue
New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null

# Check if Rust is installed
Write-Host "üîç Checking for Rust installation..." -ForegroundColor Blue
try {
    $rustVersion = cargo --version 2>$null
    Write-Host "‚úÖ Rust found: $rustVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Rust not found. Installing Rust..." -ForegroundColor Red
    
    # Download and install Rust
    Write-Host "üì• Downloading Rust installer..." -ForegroundColor Blue
    $rustupUrl = "https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe"
    $rustupPath = "$env:TEMP\rustup-init.exe"
    
    Invoke-WebRequest -Uri $rustupUrl -OutFile $rustupPath
    
    Write-Host "üîß Installing Rust (this may take a few minutes)..." -ForegroundColor Blue
    Start-Process -FilePath $rustupPath -ArgumentList "-y" -Wait
    
    # Refresh environment
    $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH", "User")
    
    Write-Host "‚úÖ Rust installation completed!" -ForegroundColor Green
}

# Check for Git
Write-Host "üîç Checking for Git installation..." -ForegroundColor Blue
try {
    $gitVersion = git --version 2>$null
    Write-Host "‚úÖ Git found: $gitVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ö†Ô∏è  Git not found. Please install Git from https://git-scm.com/download/win" -ForegroundColor Yellow
    Write-Host "Continuing installation without Git (some features may not work)..." -ForegroundColor Yellow
}

# Download or build Nitrokit
$buildFromSource = $true
$nitrokitExe = "$InstallPath\nitrokit.exe"

if ($buildFromSource) {
    Write-Host "üèóÔ∏è  Building Nitrokit from source..." -ForegroundColor Blue
    
    # Clone repository
    $tempDir = "$env:TEMP\nitrokit-build"
    if (Test-Path $tempDir) {
        Remove-Item -Path $tempDir -Recurse -Force
    }
    
    Write-Host "üì• Cloning repository..." -ForegroundColor Blue
    git clone https://github.com/mustafagenc/nitrokit-terminal.git $tempDir
    
    # Build project
    Write-Host "üî® Compiling Nitrokit..." -ForegroundColor Blue
    Set-Location "$tempDir\nitrokit"
    cargo build --release
    
    # Copy executable
    Copy-Item "target\release\nitrokit.exe" $nitrokitExe
    
    # Cleanup
    Set-Location $PSScriptRoot
    Remove-Item -Path $tempDir -Recurse -Force
} else {
    # In future, download pre-built binary
    Write-Host "üì• Downloading Nitrokit binary..." -ForegroundColor Blue
    # Invoke-WebRequest -Uri "https://github.com/mustafagenc/nitrokit/releases/latest/download/nitrokit-windows.exe" -OutFile $nitrokitExe
}

# Verify installation
if (Test-Path $nitrokitExe) {
    Write-Host "‚úÖ Nitrokit binary installed successfully!" -ForegroundColor Green
} else {
    Write-Host "‚ùå Failed to install Nitrokit binary!" -ForegroundColor Red
    exit 1
}

# Add to PATH
if ($AddToPath) {
    Write-Host "üîß Adding Nitrokit to PATH..." -ForegroundColor Blue
    
    $userPath = [System.Environment]::GetEnvironmentVariable("PATH", "User")
    if ($userPath -notlike "*$InstallPath*") {
        $newPath = "$userPath;$InstallPath"
        [System.Environment]::SetEnvironmentVariable("PATH", $newPath, "User")
        Write-Host "‚úÖ Added to PATH! (restart your terminal to use 'nitrokit' command)" -ForegroundColor Green
    } else {
        Write-Host "‚úÖ Already in PATH!" -ForegroundColor Green
    }
}

# Create desktop shortcut
if ($CreateDesktopShortcut) {
    Write-Host "üñ•Ô∏è  Creating desktop shortcut..." -ForegroundColor Blue
    
    $WshShell = New-Object -comObject WScript.Shell
    $Shortcut = $WshShell.CreateShortcut("$env:USERPROFILE\Desktop\Nitrokit.lnk")
    $Shortcut.TargetPath = "powershell.exe"
    $Shortcut.Arguments = "-Command `"& '$nitrokitExe' -i`""
    $Shortcut.WorkingDirectory = $env:USERPROFILE
    $Shortcut.IconLocation = "$nitrokitExe"
    $Shortcut.Description = "Nitrokit - Project Management Tool"
    $Shortcut.Save()
    
    Write-Host "‚úÖ Desktop shortcut created!" -ForegroundColor Green
}

# Create Start Menu shortcut
Write-Host "üìÇ Creating Start Menu shortcut..." -ForegroundColor Blue
$startMenuPath = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs"
$WshShell = New-Object -comObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut("$startMenuPath\Nitrokit.lnk")
$Shortcut.TargetPath = "powershell.exe"
$Shortcut.Arguments = "-Command `"& '$nitrokitExe' -i`""
$Shortcut.WorkingDirectory = $env:USERPROFILE
$Shortcut.IconLocation = "$nitrokitExe"
$Shortcut.Description = "Nitrokit - Project Management Tool"
$Shortcut.Save()

Write-Host "‚úÖ Start Menu shortcut created!" -ForegroundColor Green

# Installation complete
Write-Host @"

üéâ Installation completed successfully!

üìç Installation location: $InstallPath
üöÄ Usage:
   ‚Ä¢ Command line: nitrokit
   ‚Ä¢ Interactive mode: nitrokit -i
   ‚Ä¢ Generate release notes: nitrokit release-notes
   ‚Ä¢ Update dependencies: nitrokit update-dependencies

üìö Documentation: https://github.com/mustafagenc/nitrokit-terminal
üêõ Issues: https://github.com/mustafagenc/nitrokit-terminal/issues

"@ -ForegroundColor Green

if ($AddToPath) {
    Write-Host "üí° Don't forget to restart your terminal to use the 'nitrokit' command!" -ForegroundColor Yellow
}

Write-Host "Press any key to exit..." -ForegroundColor Gray
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")